<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/app.html">app</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
Moving Application
*/

/**
Require Configuration 
*/
require.config({
	paths:{
        gmap: &quot;googlemap&quot;,
        droute: &quot;directionrouting&quot;,
        async: &quot;../lib/async&quot;,
        xdate: &quot;../lib/xdate&quot;,
        geodesy: &quot;../lib/geodesy&quot;
	}
});

/**
This module contains classes for the Moving application
@module app
*/
require(
    /**
    Module dependencies, googlemap.js, directionrouting.js &amp; xdate.js
    */
    [&quot;gmap&quot;, &quot;droute&quot;, &quot;xdate&quot;],
    
	function( gmap, droute ) {
        
        &quot;use strict&quot;;
        
        // locations object
        var locations = [
            {city: &#x27;manchester&#x27;, lat: 53.479384, lng: -2.248580},
            {city: &#x27;chicago&#x27;, lat: 41.850033, lng: -86.088599},
            {city: &#x27;london&#x27;, lat: 51.508515,lng: -0.125487},
            {city: &#x27;home&#x27;, lat: 53.710781, lng: -1.714300},
            {city: &#x27;work&#x27;, lat: 53.481728 ,lng: -2.326726},
        ];

        // player object
        var player = {
            name: &#x27;You&#x27;,
            lat: null,
            lng: null,
            marker: null,
            infoWindow: null,
            endLatLng: null,
            icon: &#x27;https://maps.google.com/mapfiles/marker_green.png&#x27;,
            inTransitMode: false,
            startTime: null,
            // functions:
            setLocation: function(city) {
                // find the city in the locations object and set the coordinates
                for (var i=0; i&lt;locations.length; i++) {
                    if (locations[i].city===city) {
                        this.lat = locations[i].lat;
                        this.lng = locations[i].lng;
                        break;
                    }
                }
            },
            clicked: function() {
                // open the infowindow on the marker, with the current message in it
                gmap.openInfoWindow(this.infoWindow, this.marker);
            }
    
		};
		
		// app object
		var appVar = {
            selectingDestination: false,
            displaySteps: false,
            intervalVar: undefined,
            timeInSeconds: 0,
            totalSteps: undefined,
            cStep: undefined,
            // step intervals based on map zoom
    		stepInterval: [60000,55000,50000,45000,38000,20000,18000,14000,12000,10000,6000,3000,1500,1000,600,400,270,200,130,120,110,100]
        };

		/**
		Method to start and keep the time on the application
        @method startTime
		*/
		var startTime = function() {
            // start the timer...
            var now = new XDate();
            // display the time...
            document.getElementById(&#x27;time&#x27;).innerHTML = now.toLocaleTimeString();
            // calculate any counters here...
            calcTimings(appVar.timeInSeconds);

            var t = setTimeout(function(){startTime();},1);
        };

		// selectDestination - enable selection of desitination and set cursor as a cross hair
		var selectDestination = function() {
            gmap.setOptions({draggableCursor: &#x27;crosshair&#x27;});
            // set flag
            appVar.selectingDestination = true;
        };

		// endSelectDestination - process the selection of the destination
		var endSelectDestination = function(endLatLng) {
            // end of selecting destination
            if (appVar.selectingDestination) {
                // if selection, set the pointer back to normal
                gmap.setOptions({draggableCursor: null});
                // set the flag to not selecting
                appVar.selectingDestination = false;
                // calculate the route based on the passed in latlng
                calcRoute(endLatLng);
            }
        };

		// toggleStepsMarker - function to toggle the departure time steps being shown on the map
		var toggleStepsMarker = function() {
            var len;
            
            if (!appVar.displaySteps) {
                // show the steps
                len = appVar.totalSteps.length;
                for (var i=0; i&lt;len; i++) {
                    if (appVar.totalSteps[i].departure_time !== undefined) {
                        var lat = appVar.totalSteps[i].lat();
                        var lng = appVar.totalSteps[i].lng();
                        var brg = appVar.totalSteps[i].bearing;
                        var icon = &#x27;img/caution.png&#x27;;

                        var newDate = new XDate(appVar.totalSteps[i].departure_time.value);
                        var title = &#x27;Departure Time: &#x27;+newDate.toString(&#x27;hh:mm:ss&#x27;);
                        var marker = gmap.setMarker(lat, lng, title, icon);
                        appVar.totalSteps[i].marker = marker;
                        appVar.displaySteps = true;
                    }
                }
            } else {
                // remove the steps    
                len = appVar.totalSteps.length;
                for (var j=0; j&lt;len; j++) {
                    if (appVar.totalSteps[j].departure_time !== undefined) {
                        appVar.totalSteps[j].marker.setMap(null);
                        appVar.displaySteps = false;
                    }
                }
            }
        };

		// moveMarker - function to move the marker to a new location based on time that has transpired
		var moveMarker = function() {
			// get the location based on the time transpired
            var step = droute.getLocation(appVar.totalSteps, appVar.timeInSeconds);
            // ok we have current location
            appVar.cStep = step.currentStep;
            if(appVar.timeInSeconds === 0) {
                // if the first step then set the center of the map to by the start position
                gotoPosition();
            } else {
                // log your latlng, transit mode, infowindow and move marker
                player.lat = step.lat;
                player.lng = step.lng;
                player.inTransitMode = step.inTransitMode;
                player.infoWindow.setContent(step.stepInfo);
                player.marker.setPosition(gmap.getLatLng(player.lat, player.lng));
                if (step.destinationReached) {
                    // desitination reached return false
                    return false;
                }
            }
            // move the time on based on the stepinterval
            appVar.timeInSeconds += appVar.stepInterval[gmap.getZoom()]/1000;

            // still moving return true
            return true;
        };

		// calcTimings - function to work out the visual timings
		var calcTimings = function(timeInSeconds) {
            
            var timeleft = droute.getDuration()-appVar.timeInSeconds;

            var now = new XDate();

            now.setTime(now.getTime()+timeleft*1000);
            document.getElementById(&#x27;etatext&#x27;).innerHTML = now.toLocaleTimeString();
        };

		// startJourney - function to start the journey...
		var startJourney = function () {
 
            // don&#x27;t try and start if aleady started!
            if (appVar.intervalVar !== undefined) {return;}

            (function repeat() {
                player.startTime = new XDate();
                player.travelling = true;
                if (moveMarker()) {
                    // if movemarker not at end of directions..then setTimeout again
                    appVar.intervalVar = setTimeout(repeat, appVar.stepInterval[gmap.getZoom()]);
                } else {
                    // reset the timing variables
                    player.clicked();
                    appVar.intervalVar = undefined;
                    appVar.timeInSeconds = 0;
                    player.startTime = undefined;
                    appVar.totalSteps = undefined;
                    droute.clearDirections();
                }
            })();
        };

		// pauseJourney - function to pause the current journey
		var pauseJourney = function() {
            // pause journey; only allow a pause of a route if not inTransitMode
           if (!player.inTransitMode) {
               clearTimeout(appVar.intervalVar);
               appVar.intervalVar = undefined;
           }
        };

		// gotoPosition - move the map to the last position passed
		var gotoPosition = function() {
            gmap.setCenter(gmap.getLatLng(player.lat, player.lng));
        };

		// calcRoute - function to calculate the route
		var calcRoute = function(endLatLng) {
            // endLatLng is optional
            
            var restartJourney = false;

            // only allow a calc of a route if not inTransitMode
            if (player.inTransitMode) {return;}
            
            if (endLatLng===undefined || endLatLng===null) {
                // if a destination is not passed use the last one
                endLatLng = player.endLatLng;
                // if no last one then exit
                if (endLatLng===undefined || endLatLng===null) { return; }
            } else {
                // record the current end latlng
                player.endLatLng = endLatLng;
            }

            // if showing steps from previous route then remove
            if (appVar.displaySteps) { toggleStepsMarker(); }

            console.log(appVar.intervalVar);
            if (appVar.intervalVar !== undefined) {
                // if journey in progress then stop it...
                restartJourney = true;
                appVar.timeInSeconds = 0;
                player.startTime = null;
                pauseJourney();
            }
            
            // build request based on start and finish and transport mode
            var origin = gmap.getLatLng(player.lat, player.lng);
            var selectedMode = document.getElementById(&#x27;mode&#x27;).value;
            
            gmap.getRoute(origin, endLatLng, selectedMode, function(response) {
            	//console.log(response);
                // call processDirections on directionrouting
                droute.processDirections(response, function(response) {
                    //console.log(response);
                    appVar.totalSteps = response;
                    calcTimings(0);
                    if (selectedMode===&#x27;TRANSIT&#x27;) {toggleStepsMarker();}
                    if (restartJourney) {startJourney();}
                });
            });
        };

		// create your current position
    	player.setLocation(&#x27;work&#x27;);

		// first off initialise the map, passing in the div and the player location
        gmap.initialise( document.getElementById(&#x27;map-canvas&#x27;), player.lat, player.lng );

		// set the marker for the player and the infowindow
		player.marker = gmap.setMarker(player.lat, player.lng, player.name, player.icon);
		player.infoWindow = gmap.createInfoWindow(&#x27;Awaiting Instructions&#x27;);
    	setTimeout(function(){player.clicked();},1000);

		// add event listeners
		gmap.addEventListener(player.marker, &#x27;click&#x27;, function(){player.clicked(player);});
        gmap.addEventListener(&#x27;map&#x27;, &#x27;click&#x27;, function(event){endSelectDestination(event.latLng);});
		document.getElementById(&quot;select&quot;).onclick = selectDestination;
		document.getElementById(&quot;recalc&quot;).onclick = calcRoute;
		document.getElementById(&quot;start&quot;).onclick = startJourney;
		document.getElementById(&quot;pause&quot;).onclick = pauseJourney;
        document.getElementById(&quot;goto&quot;).onclick = gotoPosition;
		document.getElementById(&quot;mode&quot;).onchange = function(){calcRoute();};

		// start the clock...
    	startTime();
	}
);

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
